#!/bin/bash

PATH=/bin:/sbin:/usr/bin:/usr/sbin

CONF_DIR="/etc"
TMP_DIR="/tmp"
SUDO="sudoers"
SUDO_TMP="__sudoers_tmp"
SUDO_FILE="${CONF_DIR}/${SUDO}"

KADEPLOY_TAG_MARK="###"
KADEPLOY_TAG_RELEASE=""
KADEPLOY_TAG="${KADEPLOY_TAG_MARK} ${KADEPLOY_TAG_RELEASE} ${KADEPLOY_TAG_MARK}"

KABIN_DIR=""

help()
{
  die "$0 [-t|--kadeploy-tag <tag>] [-b|--bindir <bin directory>] [-i|--install] [-u|--uninstall]"
}

die()
{
  echo -e "fatal: $1 . exiting." && exit 1 
}

cleanSudoers()
{
  grep -v "${KADEPLOY_TAG}" ${SUDO_FILE} > ${TMP_DIR}/${SUDO_TMP}
}

commitSudo()
{
  ( cp ${TMP_DIR}/${SUDO_TMP} ${CONF_DIR}/${SUDO} && rm ${TMP_DIR}/${SUDO_TMP} ) || 
    die "failed to commit changes in ${CONF_DIR}/${SUDO}"
}

sudoInstall()
{
  cleanSudoers
  cat >>${TMP_DIR}/${SUDO_TMP} <<EOF
### DO NOT REMOVE - Automatically generated by Kadeploy install ${KADEPLOY_TAG}
Defaults>deploy env_reset,env_keep = "PWD PERL5LIB DISPLAY KADEPLOY_CONFIG_DIR" ${KADEPLOY_TAG}
Cmnd_Alias DEPLOYCMDUSER_${KADEPLOY_TAG_RELEASE} = ${KABIN_DIR}/kaconsole, ${KABIN_DIR}/kadeploy, ${KABIN_DIR}/kaenvironments, ${KABIN_DIR}/kareboot, ${KABIN_DIR}/karecordenv, ${KABIN_DIR}/karemote, ${KABIN_DIR}/kadatabase ${KADEPLOY_TAG}
ALL ALL=(deploy) NOPASSWD: DEPLOYCMDUSER_${KADEPLOY_TAG_RELEASE} ${KADEPLOY_TAG}
### END ${KADEPLOY_TAG}
EOF
  commitSudo
}

sudoUninstall()
{
  cleanSudoers
  commitSudo
}

check()
{
  if [ ! -f "${CONF_DIR}/${SUDO}" ]; then
    die "${CONF_DIR}/${SUDO} file not found"
  fi
  if [ ! -w "${CONF_DIR}/${SUDO}" ]; then
    die "non-writeable ${SUDO} file"
  fi
  if [ ! -d "${TMP_DIR}" ]; then
    die "${TMP_DIR} not found"
  fi
  if [ ! -w "${TMP_DIR}" ]; then
    die "${TMP_DIR} not writeable"
  fi
}

main()
{     
  if [ "$#" -eq 0 ]; then
    die "missing parameters."
  fi

  while [ -n "$1" ]; do
    case "$1" in
      -k | --kadeploy-tag)
      	local release="$2"
        KADEPLOY_TAG_RELEASE=$(echo $release | tr '[:lower:]' '[:upper:]')
	KADEPLOY_TAG="${KADEPLOY_TAG_MARK} KADEPLOY_${KADEPLOY_TAG_RELEASE}_TAG ${KADEPLOY_TAG_MARK}"
	shift
        shift;;
      -i|--install)
        SUDO_INSTALL=1
      	shift;;
      -u|--uninstall)
      	SUDO_INSTALL=0
        shift;;
      -b|--bindir)
      	KABIN_DIR="$2"
	shift
	shift;;
      -h|--help)
        help
	shift;;
      default)
      	help
	shift;;
    esac
  done
  
  check
  if [ "${SUDO_INSTALL}" -eq  0 ]; then
    sudoUninstall
  else
    sudoInstall
  fi
 
}

main $*

